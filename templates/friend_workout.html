{% extends 'base.html' %}
{% load static %}


{% block title %}{{ friend.first_name }}'s Profile{% endblock title %}

{% block content %}
    <div class="container px-md-5 px-3">
        <!-- Contact form-->
        <div class="bg-light rounded-3 py-md-5 py-4 px-md-5 px-4">
            <div class="">
                <div class="row gx-5 justify-content-center mb-2">
                    
                    <div class="col-lg-12 col-xl-6 custom-border">
                        <h1 class="fw-bolder mb-3 fs-1">{{ friend.username }}'s Profile</h1>
                        <div class="card mb-5 justify-content-between">
                            <div class="row g-0">
                                <div class="img_cont col-12 col-md-5 justify-content-md-start justify-content-center d-flex mt-md-0 mt-3">
                                    <img class="img-fluid rounded-1" src="{{ friend.profile.profile_picture.url }}" alt="Profile Picture">
    
    
                                </div>
                                <div class="col-12 col-md-7 justify-content-center d-flex align-items-center mt-md-0 mt-3">
                                    <div>

                                        {% if settings.show_personal_info%}
                                        <p class="card-text text-center mb-0 fs-5"><strong>Name:</strong> {{ friend.first_name }}</p>
                                        <p class="card-text text-center mb-0 fs-5"><strong>Age:</strong> {{ friend.profile.age }}</p>
                                        <p class="card-text text-center mb-0 fs-5"><strong>Gender:</strong> {{ friend.profile.gender }}</p>
                                        <p class="card-text text-center mb-2 fs-5"><strong>Length:</strong> {{ friend.profile.length }} cm</p>
                                        <p class="card-text text-center mb-0 fs-5"><strong>Weight:</strong> {{ last_weight }} kg</p>
                                        <p class="card-text text-center mb-0 fs-5"><strong>Muscle:</strong> {{ last_muscle }}%</p>
                                        <p class="card-text text-center mb-0 fs-5"><strong>Fat:</strong> {{ last_fat }}%</p>
                                        <p class="card-text text-center mb-3 fs-5"><strong>BMI:</strong> {{ last_bmi }}</p>
                                        {% else %}
                                        <p class="card-text text-center mb-3 fs-5"><strong>Name:</strong> {{ friend.first_name }}</p>
                                        {% endif %}
                                    </div>

    
                                </div>
                            </div>

                        </div>

                    </div>

                    <div class="col-lg-8 col-xl-6 mt-md-0 mt-2">
                        <h1 class="fw-bolder mt-4 mt-md-2">Workouts</h1>
                        <p class="lead fw-normal text-muted mb-4">Check out their workouts. If you copy a workout, you can find it in your workouts under the name {{ friend.first_name }}'s 'workout name' (copy)</p>
                        <div class="gx-5 justify-content-center mb-3">
                            <div class="all_workouts">
                                <div class="accordion mb-5" id="accordionExample">
                                    {% if workouts %}
                                        {% for workout, exercises in context%}
                                        <div class="accordion-item">
                                            <h3 class="accordion-header" id="heading{{ workout.id }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ workout.id }}" aria-expanded="false" aria-controls="collapse{{ workout.id }}">
                                                    <div class="name-container fs-5">
                                                        {{ workout.name }} 
                                                    </div>
                                                </button>
                                            </h3>
                                            <div class="accordion-collapse collapse" id="collapse{{ workout.id }}" aria-labelledby="heading{{ workout.id }}" data-bs-parent="#accordionExample">
                                                <div class="accordion-body">
                                                    {% for exercise in exercises %}

                                                        <div class="card mb-2">
                                                            <div class="card-body p-2">
                                                                <div class="row g-1 align-items-center">
                                                                    <div>            

                                                                    </div>
                                                                    <div class=" col-12 col-md-7">
                                                                        <span class="d-md-none fs-6 fw-bold"> {{ exercise.exercise }}</span> <!-- Visible on xs to sm (mobile) -->
                                                                        <span class="d-none d-md-inline fs-6 fw-bold">{{ exercise.exercise }}</span>

                                                                    </div>
                                                                    <div class="col-6 col-md-3">
                                                                        <div>Reps: {{ exercise.reps }}</div>
                                                                    </div>
                                                                    <div class="col-6 col-md-2">
                                                                        <div>Sets: {{ exercise.sets }}</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                    {% endfor %}
                                                    <div class="d-flex justify-content-end mt-4">
                                                        {% csrf_token %}
                                                        <button id="copyWorkoutButton{{ workout.id }}" class="btn btn-primary" onclick="copyWorkout({{ workout.id }});">
                                                            <i class="bi bi-clipboard"></i>
                                                            <span class="d-md-none fs-6"> Copy</span> <!-- Visible on xs to sm (mobile) -->
                                                            <span class="d-none d-md-inline fs-6">Copy this workout</span>
                                                            </button>
                                                    </div>
                                                </div>

                                            
                                            </div>

                                        </div>

                                        {% csrf_token %}
                                        <script type="text/javascript">
                                        var csrfToken = "{{ csrf_token }}";
                                        </script>
    
                                        {% endfor %}
                                    {% else %}
                                    <p class="text-muted">There are no workouts saved.</p>
                                    {% endif %}
                                </div>

                            </div>

                        </div>
                    </div>

                </div>
                {% if settings.show_sessions %}
                <div class="row gx-5 border-top mb-2"></div>

                <div class="row gx-5 justify-content-center mb-2">
                    <div class="col-12 col-lg-8 col-xl-6 custom-border">
                        <h1 class="fw-bolder mt-4">Past Sessions</h1>
                        <p class="lead fw-normal text-muted mb-3">Check out your last sessions</p>
                        <div class="mt-4 justify-content-end">
                            <form method="post" id="monthform">
                                {% csrf_token %}
                                <div class="row d-flex">
                                    <div class="mb-3 col-6 col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text d-md-none rounded-left">Y</span>
                                            <span class="input-group-text d-none d-md-inline rounded-left">Year</span>

                                            <select name="year" id="id_year" class="form-select">
                                                {% for year, name in years %}
                                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>{{ name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                    </div>
                                    <div class="mb-3 col-6 col-md-4">
                                        <div class="input-group">
                                            <span class="input-group-text d-md-none rounded-left">M</span>
                                            <span class="input-group-text d-none d-md-inline rounded-left">Month</span>

                                            <select name="month" id="id_month" class="form-select">
                                                {% for month, name in months %}
                                                <option value="{{ month }}" {% if month == current_month %}selected{% endif %}>{{ name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>

                                    </div>
                                    <div class="col-12 col-md-4 d-grid mb-3 align-items-center justify-md-content-end">
                                        <button type="submit" class="btn btn-primary ">Filter Sessions</button>
                                    </div>

                                </div>

                            </form>
                        </div>
                        <div class="gx-5 justify-content-center form-floating mb-3">
                            <div class="all_sessions">
                                <div class="accordion mb-5" id="accordionExample1">
                                    {% if sessions %}
                                
                                        {% for session, exercises in sessions %}
                                        <div class="accordion-item">
                                            <h3 class="accordion-header" id="heading{{ session.id }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ session.id }}" aria-expanded="false" aria-controls="collapse{{ session.id }}">
                                                    {{ session.name }} on {{ session.date }}
                                                </button>
                                            </h3>
                                            <div class="accordion-collapse collapse" id="collapse{{ session.id }}" aria-labelledby="heading{{ session.id }}" data-bs-parent="#accordionExample">
                                                <div class="accordion-body">
                                                    {% for exercise in exercises %}
                                                        <div class="fs-5"><strong>{{ exercise.exercise }}</strong></div>
                                                        {% for set in exercise.set_info %}
                                                        <div class="card mb-2">
                                                            <div class="card-body p-2">
                                                                <div class="row g-1 align-items-center">
                                                                    <div class="col-6 col-md-3">
                                                                        <div class="fs-6"><strong>Set:</strong> {{ set.set }}</div>
                                                                    </div>
                                                                    <div class="col-6 col-md-3">
                                                                        <div>            
                                                                            <span class="d-md-none">Wt:  {{ set.weight }}kg</span> <!-- Visible on xs to sm (mobile) -->
                                                                            <span class="d-none d-md-inline">Weight: {{ set.weight }}kg</span>
                                                                        </div>
                                                        
                                                                    </div>
                                                                    <div class="col-6 col-md-3">
                                                                        <div>Reps: {{ set.reps }}</div>
                                                                    </div>
                                                                    <div class="col-6 col-md-3">
                                                                        <div>Partials: {{ set.partials }}</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    
                                                    
                                                    
                                                    
                                                    {% endfor %}
                                                    <div class=" mt-4">
                                                        <div class="row align-items-center">
                                                            <!-- Rating on the left -->
                                                            <div class="col-12 col-md-6 mb-2 mb-md-0">
                                                                <div class="d-flex align-items-center">
                                                                    <strong class="fs-5 me-2 small-on-mobile">Rating:</strong>
                                                                    <span class="fs-5 small-on-mobile">{{ session.rating }}</span>
                                                                    <img src="{% static 'images/9004759_star_favorite_award_like_icon.png' %}" alt="Star Logo" class="ms-2 image-small-on-mobile" style="width: 24px;">
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        
                                        <style>
                                            .input-group img{
                                                margin-left: 10px !important;
                                                height:38px;
                                            }
                                            @media (max-width: 576px) { /* Targeting small devices */
                                                .small-on-mobile {
                                                    font-size: 0.8rem; /* Smaller text on mobile */
                                                }
                                                .image-small-on-mobile {
                                                    width: 20px; /* Smaller image on mobile */
                                                }
                                            }

                                        </style>
                                        {% csrf_token %}
                                        <script type="text/javascript">
                                        var csrfToken = "{{ csrf_token }}";
                                        </script>


                                        {% endfor %}
    
                                    {% else %}
                                        <p>They have no sessions saved.</p>
                                    {% endif %}
                                </div>

                            </div>

                        </div>
                    </div>

                    <div class="col-lg-8 col-xl-6 mt-md-0 mt-2">
                        <h1 class="fw-bolder mt-4">Session statistics</h1>
                        <p class="lead fw-normal text-muted mb-4">See {{ friend.username }}'s overall session statistics</p>
                        <div class="card mb-4">

                            {% if stats_available %}
                                <div class="card-body shadow">
                                    <div class="mt-2 mb-2 justify-content-end">
                                        {% for timeframe, stats in workout_stats.items %}

                                        {% if stats %}
                                        <h3 class="mb-2">{{ timeframe|title }}:</h3>
                                            <table class="table mb-3">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center">Workout Type</th>
                                                        <th class="text-center">Session Count</th>
                                                        <th class="text-center">Avg Rating</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for stat in stats %}
                                                        <tr>
                                                            <td class="text-center">{{ stat.name }}</td>
                                                            <td class="text-center">{{ stat.session_count }}</td>
                                                            <td class="text-center">{{ stat.avg_rating }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        {% else %}

                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="card-body shadow ">
                                    <p class="mb-0 fst-italic text-muted">No stats yet</p>
                                </div>
                            {% endif %}
                        <!-- <div class="btn_container">
                            <a class="btn btn-primary btn-lg px-4 me-sm-3" href="{% url 'create_workout' %}">New</a>
                        </div> -->
                        </div>
                    </div>

                </div>
                {% endif %}
                {% if settings.show_progress %}
                <div class="row gx-5 border-top mb-2"></div>
                <div class="row gx-5 justify-content-center">
                    <div class="col-lg-8 col-xl-6 custom-border">
                        <h1 class="fw-bolder mt-4">{{ friend.first_name }}'s Progression</h1>
                        <p class="lead fw-normal text-muted mb-4">Check out {{ friend.first_name }}'s progress for all their exercises. You can compare your progression to them as well!</p>
                        <form id="answer-form" method="post" name="testform" action="{% url 'plot_friend' user_id=friend.id %}" >
                            {% csrf_token %}
                            <div class="row align-items-center mb-4 g-2 justify-content-between">
                                <div class="col-6 col-sm-4 ">
                                    <div class="mb-2 mb-sm-0">
        
                                        <select class="exercise-dropdown form-select" id="exercise-dropdown" name="exercise" class="form-select" required>
                                            <option value=""> None </option>
                                            {% for exercise in exercises %}
                                            <option value="{{ exercise }}">{{ exercise }}</option>
                                            {% endfor %}
                                        
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3 mb-2 mb-sm-0">
                                    <select class="exercise-dropdown form-select" id="exercise-dropdown1" name="progression" class="form-select" required>
                                        <option value="Progression Index"> Progression Index </option>
                                        <option value="Progression Over Time"> Progression Over Time </option>
        
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="myProgressionCheckbox" name="my_progression">
                                        <label class="form-check-label" for="myprogressionCheckbox">My progress</label>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-2">
                                    <div class="btn-container">
                                        <button type="submit" class="btn btn-primary">Show</button>
                                    </div>
        
                                </div>
                            </div>
                        </form>
                        <div class="card mb-5">
                            <div class="card-body p-1 p-md-2">
                            <canvas id="progressionChart"></canvas>
                            </div>
                        </div>

                    </div>
                    <div class="col-12 col-lg-8 col-xl-6 mt-md-0 mt-2">
                        <h1 class="fw-bolder mt-4">{{ friend.first_name }}'s PRs</h1>
                        <p class="lead fw-normal text-muted mb-4">Check out {{ friend.first_name }}'s PRs for all their exercises and reps. You can compare your PRs to theirs as well!</p>
                        <form id="answer-form1" method="post" name="testform" action="{% url 'plot_prs_friend' user_id=friend.id %}" >
                            {% csrf_token %}
                            <div class="row align-items-center g-3 mb-4 justify-content-between">
                                <div class="col-6 col-sm-4">
                                    <div class="mb-sm-0">
                                        <select class="exercise-dropdown form-select" id="exercise-dropdown2" name="exercise" class="form-select" required>
                                            <option value="" aria-placeholder="Exercise"> None </option>
                                            {% for exercise in exercises1 %}
                                            <option value="{{ exercise }}">{{ exercise }}</option>
                                            {% endfor %}
        
                                        </select>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3
                                mb-sm-0">
                                    <!-- Reps Select (to be dynamically filled) -->
                                    <select class="rep-dropdown form-select" id="reps-dropdown" name="reps" required>
                                        <option value="">Select Reps</option>
                                        <!-- Options will be added here based on the selected exercise -->
                                    </select>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="myPRsCheckbox" name="my_prs">
                                        <label class="form-check-label" for="myPRsCheckbox">My PR</label>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-2 ">
                                    <div class="btn-container">
                                        <button type="submit" class="btn btn-primary">Show</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div class="card mb-3">
                            <div class="card-body">
                            <canvas id="progressionChart1"></canvas>
                            </div>
                        </div>
                    </div>



                </div>
                {% endif %}
            </div>


        </div> 

        <style>
            /* Override Select2 styling */
            /* Custom styles for Select2 to match Bootstrap, with responsiveness in mind */
            .select2-container .select2-selection--single {
                height: calc(2.25rem + 2px);
                padding: .375rem 1.75rem .375rem .1rem;
                border: 1px solid #ced4da;
                border-radius: .25rem;
                transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            }
            .select2-container .select2-selection--single .select2-selection__arrow {
                    right: .375rem;
                    top: 0.375rem
            }
            .select2-container--default .select2-results__option {
                line-height: 24px; /* Adjust the value as needed */
            }
            
            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 24px; /* Adjust for the selected item */
            }

            .img_cont img{
                    max-width: 250px;
                    max-height:350px;
            }
            @media (max-width: 768px) {

            }
            @media (max-width: 768px) {
                .select2-container .select2-selection--single {
                    padding: .375rem .1rem;
                }
                .select2-container .select2-selection--single .select2-selection__arrow {
                    right: .375rem;
                    top: 0.375rem
                }
                .chartContainer {
                    width: calc(316/412*100vw);
                    height: calc(316/412*100vw);
                }
                .img_cont img{
                    max-width: 200px;
                    max-height:285px;
                }

            
            }

            .btn-container{
                display: flex;
                justify-content: flex-end;
            }
        </style>
                <script>

                    $(document).ready(function() {
                        // Initialize Select2
                        $('.exercise-dropdown').select2({
                            width: '100%',
                            placeholder: 'Exercise',
                        });
                        $('.rep-dropdown').select2({
                            width: '100%',
                            placeholder: 'Reps',
                        });
                        function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                const cookies = document.cookie.split(';');
                                for (let i = 0; i < cookies.length; i++) {
                                    const cookie = cookies[i].trim();
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                
                        const csrftoken = getCookie('csrftoken');
        
                        // AJAX form submission
                        $("#answer-form").submit(function(e) {
                            e.preventDefault(); // Prevent the default form submission
                            const formData = $(this).serialize(); // Serialize form data
        
                            $.ajax({
                                url: '{% url "plot_friend" user_id=friend.id %}', // URL to your Django view that handles this form
                                type: 'POST',
                                data: formData,
                                dataType: 'json', // Assuming you're expecting a JSON response
                                    beforeSend: function(xhr) {
                                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                                    },
                                    success: function(response) {
                                        if(response.success) {
        
                                            var progressionData = JSON.parse(response.context.progression_plot_data)
                                            updateChartWithData(progressionData)
                                            // Handle success (e.g., redirect or clear the form)
                                        } else {
                                            alert("Error: " + response.error);
                                            // Handle failure
                                        }
                                    },
                                    error: function(response) {
                                        // Handle AJAX error
                                        console.log(response.error);
                                    },
        
                            });
                        });
                        $('#exercise-dropdown2').change(function() {
                            var exerciseId = $(this).val();
        
                            $.ajax({
                                url: '{% url "show_reps_friend" user_id=friend.id %}',
                                type: 'POST',
                                data: {'exercise': exerciseId},
                                dataType: 'json', // Assuming you're expecting a JSON response
                                    beforeSend: function(xhr) {
                                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                                    },
                                    success: function(data) {
                                        var repsDropdown = $('#reps-dropdown');
                                        repsDropdown.empty(); // Clear existing options
                                        repsDropdown.append($('<option>').val('').text('Select Reps')); // Add default option
        
                                        // Populate reps dropdown with new options
                                        $.each(data.reps.sort(function(a, b) { return a - b; }), function(index, rep) {
                                            repsDropdown.append($('<option>').val(rep).text(rep));
                                        });
                                    },
                                
                            });
                        });
                        $("#answer-form1").submit(function(e) {
                            e.preventDefault(); // Prevent the default form submission
                            const formData = $(this).serialize(); // Serialize form data
                            $.ajax({
                                url: '{% url "plot_prs_friend" user_id=friend.id %}', // URL to your Django view that handles this form
                                type: 'POST',
                                data: formData,
                                dataType: 'json', // Assuming you're expecting a JSON response
                                    beforeSend: function(xhr) {
                                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                                    },
                                    success: function(response) {
                                        if(response.success) {
                                            var prData = JSON.parse(response.context.pr_plot_data)
                                            updateChartWithData1(prData)
                                            // Handle success (e.g., redirect or clear the form)
                                        } else {
                                            alert("Error: " + response.error);
                                            // Handle failure
                                        }
                                    },
                                    error: function(response) {
                                        // Handle AJAX error
                                        console.log(response.error);
                                    },
        
                            });
                        });

                    });
        
        
                    function updateChartWithData1(progressionData) {
                        // Assuming progressionData is an object with 'dates' and 'progression_indexes' arrays
                        const ctx = document.getElementById('progressionChart1').getContext('2d');
                        var datasets = [];
                        if(progressionData.my_weight){
                            datasets.push({
                                label: 'Me',
                                data: progressionData.my_weight.map(weight => weight === null ? NaN : weight), // Convert None to NaN
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1,
                                spanGaps: true  // This allows Chart.js to draw lines over gaps
                            });
                        }
                        if(progressionData.friend_weight){
                            datasets.push({
                                label: 'Friend',
                                data: progressionData.friend_weight.map(weight => weight === null ? NaN : weight), // Convert None to NaN
                                borderColor: 'rgb(255, 99, 132)',
                                tension: 0.1,
                                spanGaps: true  // This allows Chart.js to draw lines over gaps
                            });
                        }
                        
                    

                        // Check if the chart instance already exists
                        if (window.progressionChart1.data) {
        
                            // Update the existing chart data and re-render
                            window.progressionChart1.data.labels = progressionData.dates;
                            window.progressionChart1.data.datasets = datasets;
                            window.progressionChart1.update();
                        } else {
                            // If the chart doesn't exist, create a new instance
                            window.progressionChart1 = new Chart(ctx, {
                                type: 'line',  // Assuming a line chart, adjust as needed
                                data: {
                                    labels: progressionData.dates,  // x-axis labels (e.g., dates)
                                    datasets: datasets
                                },
                                options: {   
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    aspectRatio: 1.2,
                                    scales: {
                                        x: {  // Use 'x' instead of 'xAxes' for Chart.js version 3+

                                            ticks: {
                                                autoSkip: true,
                                                maxTicksLimit: 20  // Limit the number of ticks on the x-axis
                                            }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Weight (kg)'
                                            },
        
                                        }
                                    }
                                }
                            });
                        }
                    }
                    function updateChartWithData(progressionData) {
                        // Assuming progressionData is an object with 'dates' and 'progression_indexes' arrays
                        const ctx = document.getElementById('progressionChart').getContext('2d');
                        var datasets = [];
                        if(progressionData.my_progression_indexes){
                            datasets.push({
                                label: 'Me',
                                data: progressionData.my_progression_indexes.map(progression => progression === null ? NaN : progression), // Convert None to NaN
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1,
                                spanGaps: true  // This allows Chart.js to draw lines over gaps
                            });
                        }
                        if(progressionData.friend_progression_indexes){
                            datasets.push({
                                label: 'Friend',
                                data: progressionData.friend_progression_indexes.map(progression => progression === null ? NaN : progression), // Convert None to NaN
                                borderColor: 'rgb(255, 99, 132)',
                                tension: 0.1,
                                spanGaps: true  // This allows Chart.js to draw lines over gaps
                            });
                        }
                        // Check if the chart instance already exists
                        if (window.progressionChart.data) {
        
                            // Update the existing chart data and re-render
                            window.progressionChart.data.labels = progressionData.dates;
                            window.progressionChart.data.datasets = datasets;
                            window.progressionChart.update();
                        } else {
                            // If the chart doesn't exist, create a new instance
                            window.progressionChart = new Chart(ctx, {
                                type: 'line',  // Assuming a line chart, adjust as needed
                                data: {
                                    labels: progressionData.dates,  // x-axis labels (e.g., dates)
                                    datasets: datasets
                                },
                                options: {   
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    aspectRatio: 1.2,
                                    scales: {
                                        x: {  // Use 'x' instead of 'xAxes' for Chart.js version 3+

                                            ticks: {
                                                autoSkip: true,
                                                maxTicksLimit: 20  // Limit the number of ticks on the x-axis
                                            }
                                        },
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Progression'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                    function copyWorkout(workoutId) {
                        const button = document.getElementById('copyWorkoutButton' + workoutId);
                        const icon = button.querySelector('i'); 
                        $.ajax({
                            url: '{% url "copy_workout" workout_id=0 %}'.replace('0', workoutId),
                            type: 'POST',
                            data: {
                                'csrfmiddlewaretoken': '{{ csrf_token }}'
                            },
                            success: function(response) {
                                if (response.success) {
                                    while (button.firstChild && button.firstChild !== icon) {
                                        button.removeChild(button.firstChild);
                                    }
                                    while (button.lastChild && button.lastChild !== icon) {
                                        button.removeChild(button.lastChild);
                                    }

                                    // Change the icon class
                                    icon.classList.remove('bi-clipboard');
                                    icon.classList.add('bi-clipboard-check');

                                    // Create a new text node and append after the icon
                                    const textNode = document.createTextNode(' Copied'); // Space added before "Copied" for formatting
                                    button.appendChild(textNode);

                                    // Update button styles
                                    button.classList.remove('btn-primary');
                                    button.classList.add('btn-outline-primary');
                                    button.disabled = true;  // Optionally disable the button
                                } else {
                                    alert('Error: ' + response.error);
                                }
                                // Update the UI or redirect as needed
                            },
                            error: function(xhr, status, error) {
                                alert('Error copying workout: ' + error);
                            }
                        });
                    }
        

                    $(document).ready(function() {
                        $('#monthform').on('submit', function(e) {
                            e.preventDefault();
                            var formData = $(this).serialize();
                            $.ajax({
                                url: '{% url "view_friend_workout" user_id=friend.id %}',
                                type: 'POST',
                                data: formData,
                                success: function(data) {
                                    $('#accordionExample1').html(data.html);
                                },
                                error: function() {
                                    alert('Failed to update the sessions.');
                                }
                            });
                        });
                    });

        
                </script>
        <!-- Contact cards-->

    </div>
{% endblock content %}


